# Keymap 阶段1运行时测试清单

**测试目标**: 完成阶段1的剩余10%，验证应用能够正常运行并完成所有基础功能

**预计耗时**: 15-30分钟

**前置条件**:
- ✅ 项目已成功编译（BUILD SUCCEEDED）
- ✅ macOS 版本 >= 14.0
- ✅ Xcode 版本 >= 15.0

---

## 测试环境准备

### 1. 清理旧权限记录（如果之前测试过）

```bash
# 1. 打开系统设置
open "x-apple.systempreferences:com.apple.preference.security?Privacy_Accessibility"

# 2. 手动移除旧的 Keymap.app 权限（如果存在）
# 3. 关闭系统设置
```

### 2. 清理旧的编译产物

```bash
# 在项目目录执行
cd /Users/David/Sites/Keymap

# 清理构建缓存
xcodebuild -project Keymap.xcodeproj -scheme Keymap clean

# 删除 DerivedData（可选）
rm -rf ~/Library/Developer/Xcode/DerivedData/Keymap-*
```

---

## 第一部分：启动验证（关键）

### ✅ 测试1.1: 应用能够启动

**步骤**:
1. 在 Xcode 中打开项目
   ```bash
   open Keymap.xcodeproj
   ```

2. 选择 Target: `Keymap`

3. 点击 Run (⌘R)

**预期结果**:
- [ ] 应用成功启动，无崩溃
- [ ] Xcode 控制台无红色错误信息
- [ ] 应用进程出现在活动监视器中

**如果失败**:
- 检查控制台错误信息
- 确认 Info.plist 路径正确
- 确认 Entitlements.plist 路径正确

---

### ✅ 测试1.2: Dock 和菜单栏显示正确

**步骤**:
1. 应用启动后，观察 Dock 栏

2. 观察菜单栏右侧

**预期结果**:
- [ ] **Dock 栏不显示 Keymap 图标** (LSUIElement=true)
- [ ] **菜单栏显示键盘图标 ⌨️**（右上角）

**如果失败**:
- Dock 显示图标 → 检查 Info.plist 中 LSUIElement 是否为 true
- 菜单栏无图标 → 检查 AppDelegate.swift 中 setupMenuBar() 是否被调用

---

### ✅ 测试1.3: 权限请求对话框

**步骤**:
1. 应用首次运行时，应弹出权限请求对话框

2. 如果没有弹出，点击菜单栏图标查看菜单

**预期结果**:
- [ ] **自动弹出辅助功能权限请求对话框**
- [ ] 对话框内容包含 "Keymap 需要辅助功能权限" 等说明

**如果失败**:
- 未弹出对话框 → 检查 PermissionManager.swift 是否正确调用
- 检查控制台是否有权限相关错误

---

### ✅ 测试1.4: 授予辅助功能权限

**步骤**:
1. 点击对话框中的 "打开系统设置" 按钮

2. 在 `系统设置 → 隐私与安全性 → 辅助功能` 中：
   - 找到 Keymap.app
   - 勾选启用

3. 返回 Xcode，重启应用 (⌘R)

**预期结果**:
- [ ] **系统设置中能找到 Keymap.app**
- [ ] **成功勾选权限**
- [ ] **重启后无权限请求对话框**

---

## 第二部分：全局监控验证（核心）

### ✅ 测试2.1: 全局监控启动

**步骤**:
1. 查看 Xcode 控制台输出

**预期结果**:
- [ ] 看到输出: `✅ 全局监控已启动`

**如果失败**:
- 未看到输出 → 检查 AppDelegate.applicationDidFinishLaunching 中是否调用 GlobalEventMonitor.shared.startMonitoring()
- 看到 `⚠️ 需要辅助功能权限` → 返回测试1.4重新授权

---

### ✅ 测试2.2: 双击 Cmd 键检测

**步骤**:
1. 在键盘上快速双击左侧 Cmd 键（间隔 < 0.3 秒）

2. 观察控制台输出

**预期结果**:
- [ ] 控制台输出: `⌘ 检测到双击Cmd`
- [ ] **快捷键面板自动弹出**

**如果失败**:
- 无输出 → 调整双击速度，确保间隔 < 0.3 秒
- 有输出但面板不弹出 → 检查 AppDelegate 中 NotificationCenter 监听是否正确
- 调整灵敏度: 修改 `DoubleCmdDetector.swift` 中 `doublePressThreshold` (默认 0.3)

---

### ✅ 测试2.3: 快捷键组合检测

**步骤**:
1. 按下快捷键组合:
   - ⌘C (复制)
   - ⌘V (粘贴)
   - ⌘T (新标签)
   - ⌘⇧N (新隐私窗口)

2. 观察控制台输出

**预期结果**:
- [ ] 每次按下都输出: `⌨️ 检测到快捷键: ⌘C - [应用名]`
- [ ] 显示当前前台应用名称
- [ ] 修饰键组合正确识别（⌘, ⇧, ⌥, ⌃）

**如果失败**:
- 无输出 → 检查 KeyCombinationDetector.detectKeyCombination 逻辑
- 修饰键识别错误 → 检查 parseModifiers 方法

---

## 第三部分：UI功能验证（关键）

### ✅ 测试3.1: 快捷键面板显示

**步骤**:
1. 双击 Cmd 键打开快捷键面板

2. 观察面板内容

**预期结果**:
- [ ] **面板成功弹出**
- [ ] **面板半透明**（背景模糊效果）
- [ ] **面板居中显示**
- [ ] **面板大小合适**（约 600x400）

**如果失败**:
- 面板不透明 → 检查 ShortcutPanelWindow.swift 中 alphaValue 和 isOpaque 设置
- 面板位置错误 → 检查 centerWindow() 方法

---

### ✅ 测试3.2: 快捷键列表内容

**步骤**:
1. 打开 Safari 浏览器

2. 双击 Cmd 键，观察面板内容

**预期结果**:
- [ ] **显示 Safari 的快捷键**（如果已缓存或提取成功）
- [ ] **显示系统快捷键**（30个，如 ⌘Q, ⌘W, ⌘Space 等）
- [ ] **快捷键按分类显示**（通用、编辑、窗口等）
- [ ] **每个快捷键有描述和图标**

**如果失败**:
- 无快捷键显示 → 检查 ShortcutPanelViewModel.loadShortcuts 逻辑
- 无 Safari 快捷键 → 阶段2的提取功能可能有问题，但系统快捷键应该显示

---

### ✅ 测试3.3: 搜索功能

**步骤**:
1. 在快捷键面板顶部搜索框输入: "复制"

2. 观察搜索结果

**预期结果**:
- [ ] **搜索框可输入文字**
- [ ] **快捷键列表实时过滤**
- [ ] **显示匹配 "复制" 的快捷键**（⌘C）

---

### ✅ 测试3.4: 面板关闭

**步骤**:
1. 点击面板外部区域

2. 按 Esc 键

**预期结果**:
- [ ] **点击外部可关闭面板**
- [ ] **按 Esc 可关闭面板**
- [ ] **面板动画平滑**

**如果失败**:
- 点击外部无效 → 检查 ShortcutPanelWindow 中 resignKey() 实现

---

### ✅ 测试3.5: 菜单栏功能

**步骤**:
1. 点击菜单栏键盘图标 ⌨️

2. 查看菜单项

3. 点击 "显示快捷键" 菜单项

**预期结果**:
- [ ] **菜单正确显示**
- [ ] 包含菜单项: "显示快捷键", "统计分析", "设置", "退出"
- [ ] **点击 "显示快捷键" 打开面板**
- [ ] **点击 "退出" 关闭应用**

---

## 第四部分：性能验证（重要）

### ✅ 测试4.1: CPU 使用率

**步骤**:
1. 打开活动监视器: `open -a "Activity Monitor"`

2. 搜索 "Keymap"

3. 观察 CPU 使用率（后台运行，不触发快捷键）

**预期结果**:
- [ ] **CPU 使用率 < 5%**
- [ ] 无异常高 CPU 占用

**如果失败**:
- CPU > 10% → 可能是事件监控频率过高，需要优化

---

### ✅ 测试4.2: 内存占用

**步骤**:
1. 在活动监视器中查看 Keymap 的内存占用

**预期结果**:
- [ ] **内存占用 < 100MB**

---

### ✅ 测试4.3: 响应速度

**步骤**:
1. 双击 Cmd 键，记录面板弹出时间

2. 按下快捷键，观察检测延迟

**预期结果**:
- [ ] **面板弹出响应时间 < 200ms**（感觉即时）
- [ ] **快捷键检测无明显延迟**

---

## 第五部分：错误处理验证（可选）

### ✅ 测试5.1: 无权限运行

**步骤**:
1. 在系统设置中移除 Keymap 的辅助功能权限

2. 重启应用

**预期结果**:
- [ ] **显示权限请求对话框**
- [ ] **控制台输出: `⚠️ 需要辅助功能权限`**
- [ ] **应用不会崩溃**

---

### ✅ 测试5.2: 重复启动

**步骤**:
1. 应用已运行

2. 再次运行应用（⌘R）

**预期结果**:
- [ ] **不会启动第二个实例**（菜单栏只有一个图标）
- [ ] 或弹出提示 "应用已在运行"

---

## 测试结果总结

### 完成情况统计

- **第一部分（启动验证）**: __/4 通过
- **第二部分（全局监控）**: __/3 通过
- **第三部分（UI功能）**: __/5 通过
- **第四部分（性能验证）**: __/3 通过
- **第五部分（错误处理）**: __/2 通过

**总计**: __/17 通过

---

## 常见问题排查

### 问题1: 应用闪退，控制台显示 "Code Signature Invalid"

**原因**: Entitlements.plist 配置错误

**解决**:
1. 打开 `Keymap/Resources/Entitlements.plist`
2. 确认包含:
   ```xml
   <key>com.apple.security.app-sandbox</key>
   <false/>
   ```
3. 重新编译

---

### 问题2: 双击 Cmd 无反应，控制台无任何输出

**原因**: GlobalEventMonitor 未启动

**解决**:
1. 检查控制台是否有 "✅ 全局监控已启动"
2. 检查 AppDelegate.applicationDidFinishLaunching 中:
   ```swift
   GlobalEventMonitor.shared.startMonitoring()
   ```
3. 检查辅助功能权限是否授予

---

### 问题3: 面板显示但内容为空

**原因**: ShortcutPanelViewModel 未加载数据

**解决**:
1. 检查 ShortcutPanelViewModel.loadShortcuts 是否被调用
2. 查看控制台是否有提取错误
3. 至少应显示 30 个系统快捷键（SystemShortcutProvider）

---

### 问题4: 菜单栏无图标

**原因**: AppDelegate.setupMenuBar 未执行

**解决**:
1. 检查 AppDelegate.applicationDidFinishLaunching 中是否调用 setupMenuBar()
2. 检查 Info.plist 中 LSUIElement 是否为 true
3. 重启应用

---

## 测试完成后的操作

### ✅ 所有测试通过（17/17）

恭喜！阶段1已 100% 完成。请执行以下操作：

1. **更新 PLAN.md**:
   ```markdown
   阶段1: 创建Xcode项目    [█] 100%  ✅ 已完成
   ```

2. **创建测试报告** (可选):
   ```bash
   # 截图保存到 Screenshots/ 目录
   - 菜单栏图标
   - 快捷键面板
   - 活动监视器（性能）
   ```

3. **提交代码** (可选):
   ```bash
   git add .
   git commit -m "✅ 完成阶段1: Xcode项目创建和运行验证"
   git tag v0.1-stage1-complete
   ```

4. **继续阶段2** 或根据 PLAN.md 继续下一阶段开发

---

### ⚠️ 部分测试失败（< 17/17）

如果有测试失败，请：

1. **记录失败项**:
   - 第X部分 - 测试Y.Z: [失败原因]

2. **查看常见问题排查**（见上）

3. **查看相关日志**:
   ```bash
   # Xcode 控制台
   # ~/Library/Logs/Keymap/（如果有日志文件）
   ```

4. **寻求帮助**:
   - 检查 CLAUDE.md 故障排除章节
   - 查看 GitHub Issues（如果项目开源）

---

**测试日期**: ____年____月____日
**测试人员**: ____________________
**应用版本**: 0.1 (Stage 1)
**测试环境**: macOS ____.____, Xcode ____

---

**备注**:
- 此清单用于完成 PLAN.md 中阶段1的剩余 10%（运行时验证）
- 完成此测试后，阶段1进度将从 90% 更新为 100%
- 所有测试应在干净的环境中进行（无旧的权限记录、缓存等）
