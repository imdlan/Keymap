# Keymap 测试指南

**最后更新**: 2025-12-19

---

## 📋 阶段2：快捷键提取功能测试

### 测试准备

1. **授予辅助功能权限**
   ```
   系统设置 → 隐私与安全性 → 辅助功能
   添加并勾选：Keymap.app
   ```

2. **打开应用**
   - 方式1（Xcode）：在Xcode中点击 Run (⌘R)
   - 方式2（命令行）：
     ```bash
     open ~/Library/Developer/Xcode/DerivedData/Keymap-*/Build/Products/Debug/Keymap.app
     ```

### 测试步骤

#### 测试1：基础功能验证

**预期行为**：
- ✅ 应用启动后，Dock不显示图标
- ✅ 菜单栏右上角显示键盘图标 ⌨️
- ✅ 双击 Cmd 键弹出快捷键面板

**测试步骤**：
1. 启动应用
2. 观察菜单栏是否有键盘图标
3. 快速双击 Cmd 键（间隔 < 0.3秒）
4. 观察是否弹出快捷键面板窗口

**控制台输出检查**：
```
✅ 全局监控已启动
⌘ 检测到双击Cmd
🔍 开始提取快捷键: [应用Bundle ID]
```

---

#### 测试2：快捷键提取功能

**测试场景1：提取 Safari 快捷键**

1. 打开 Safari 浏览器
2. 双击 Cmd 键打开 Keymap 面板
3. 观察快捷键列表

**预期结果**：
- ✅ 显示 Safari 的快捷键（如 ⌘T 新标签页、⌘L 定位到地址栏等）
- ✅ 同时显示系统级快捷键（⌘Q、⌘W、⌘Space等）
- ✅ 快捷键总数 > 40

**控制台输出检查**：
```
🔍 开始提取快捷键: com.apple.Safari
✅ 提取到 X 个菜单项
✅ 成功解析 Y 个快捷键
💾 缓存快捷键: com.apple.Safari - Y个
✅ 加载完成: Z 个快捷键
```

---

**测试场景2：提取 Xcode 快捷键**

1. 打开 Xcode
2. 双击 Cmd 键打开 Keymap 面板
3. 观察快捷键列表

**预期结果**：
- ✅ 显示 Xcode 的快捷键（如 ⌘B 构建、⌘R 运行等）
- ✅ 快捷键按分类显示（文件、编辑、视图等）

---

#### 测试3：缓存功能验证

**测试步骤**：
1. 打开 Safari，双击 Cmd 弹出面板（第一次）
2. 关闭面板
3. 再次双击 Cmd 弹出面板（第二次）

**预期结果**：
- 第一次：控制台显示 `🔍 开始提取快捷键`
- 第二次：控制台显示 `📦 从缓存加载快捷键` 或 `📦 内存缓存命中`

**缓存位置验证**：
```bash
# 查看 UserDefaults 中的缓存
defaults read com.yourcompany.Keymap | grep shortcut_cache
```

---

#### 测试4：系统快捷键列表

**验证项**：
- [ ] ⌘Q - 退出应用
- [ ] ⌘W - 关闭窗口
- [ ] ⌘⇧3 - 全屏截图
- [ ] ⌘⇧4 - 截取选定区域
- [ ] ⌘Space - Spotlight搜索
- [ ] ⌘Tab - 切换应用
- [ ] ⌘C - 复制
- [ ] ⌘V - 粘贴
- [ ] ⌘Z - 撤销
- [ ] ⇧⌘Z - 重做

**检查方式**：
切换到任意应用，打开 Keymap 面板，向下滚动查看系统快捷键部分。

---

#### 测试5：错误处理

**测试场景1：无快捷键的应用**
1. 打开一个简单应用（如计算器）
2. 双击 Cmd

**预期结果**：
- 如果提取失败，显示演示数据
- 控制台：`⚠️ 未提取到快捷键，使用演示数据`

**测试场景2：无权限应用**
1. 确保辅助功能权限未授予
2. 双击 Cmd

**预期结果**：
- 弹出权限请求对话框
- 或显示权限未授予的提示

---

### 性能测试

#### 测试6：提取速度

**测试方法**：
观察控制台输出的时间戳，计算从 `🔍 开始提取` 到 `✅ 加载完成` 的时间。

**预期结果**：
- 首次提取（无缓存）：< 5秒
- 缓存命中：< 0.1秒

#### 测试7：内存占用

**测试方法**：
```bash
# 运行应用后查看内存占用
ps aux | grep Keymap
```

**预期结果**：
- 内存占用 < 100MB

---

### 功能验证清单

#### 核心功能
- [ ] 应用正常启动
- [ ] 菜单栏图标显示
- [ ] 双击 Cmd 弹出面板
- [ ] 从 Safari 提取快捷键成功
- [ ] 从 Xcode 提取快捷键成功
- [ ] 系统快捷键列表完整（35+）

#### 缓存功能
- [ ] 第一次提取后缓存成功
- [ ] 第二次从缓存加载成功
- [ ] 缓存统计功能正常
- [ ] 缓存过期机制正常（24小时）

#### UI显示
- [ ] 快捷键列表正常显示
- [ ] 搜索功能正常
- [ ] 分类显示正常
- [ ] 滚动流畅无卡顿

#### 错误处理
- [ ] 无快捷键应用降级到演示数据
- [ ] 无权限时正确提示
- [ ] 提取超时不崩溃（5秒超时）

---

### 常见问题排查

#### 问题1：双击 Cmd 没有反应
**排查步骤**：
1. 检查辅助功能权限
2. 查看控制台是否有 `⌘ 检测到双击Cmd` 输出
3. 调整双击阈值（在 DoubleCmdDetector.swift 修改）

#### 问题2：没有提取到快捷键
**排查步骤**：
1. 查看控制台输出的错误信息
2. 确认应用有菜单栏
3. 手动在该应用打开菜单查看是否有快捷键

#### 问题3：缓存没有生效
**排查步骤**：
```bash
# 清除缓存重新测试
defaults delete com.yourcompany.Keymap
```

#### 问题4：应用崩溃
**排查步骤**：
1. 查看崩溃日志：`~/Library/Logs/DiagnosticReports/`
2. 检查 Xcode 控制台的崩溃堆栈
3. 确认代码签名和 Entitlements 配置正确

---

### 测试报告模板

完成测试后，请填写以下报告：

```markdown
## 测试结果报告

**测试日期**: YYYY-MM-DD
**测试人**: [姓名]
**系统版本**: macOS X.X.X
**Xcode版本**: X.X.X

### 功能测试
- [ ] 基础功能: [通过/失败] - [备注]
- [ ] Safari提取: [通过/失败] - 提取到 X 个快捷键
- [ ] Xcode提取: [通过/失败] - 提取到 X 个快捷键
- [ ] 缓存功能: [通过/失败] - [备注]
- [ ] 系统快捷键: [通过/失败] - 显示 X 个

### 性能测试
- 首次提取速度: X 秒
- 缓存命中速度: X 秒
- 内存占用: X MB

### 发现的问题
1. [问题描述]
   - 严重程度: [高/中/低]
   - 重现步骤: [...]
   - 预期行为: [...]
   - 实际行为: [...]

### 建议改进
1. [改进建议]

### 总体评价
[通过/不通过] - [总结]
```

---

### 下一步

测试通过后，可以继续：
- 阶段3：冲突检测引擎开发
- 优化快捷键提取算法
- 添加更多系统快捷键
- 实现手动添加快捷键功能
