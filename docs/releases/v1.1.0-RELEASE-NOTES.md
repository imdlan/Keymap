# Keymap v1.1.0 发布说明

**发布日期**: 2025-12-25
**分支**: feature/settings-menu-optimization
**版本类型**: 功能增强版本

---

## 📋 总览

v1.1.0 是一个重大功能增强版本，主要聚焦于**设置系统完善**、**UI美化优化**和**统计功能改进**。本版本包含 17 个主要提交，涉及 10+ 个文件的修改，新增 2 个核心工具类。

---

## ✨ 主要功能更新

### 1. 设置系统完善（核心更新）

#### 新增设置项
- ✅ **开机自动启动** - 使用 SMAppService API（macOS 13+）
- ✅ **显示冲突通知开关** - 可关闭系统通知
- ✅ **触发快捷键选择** - 支持双击 Cmd/Option/Control 三种修饰键
- ✅ **面板自动关闭延迟** - 0-30秒可调，0为禁用
- ✅ **全局快捷键重映射开关** - 可在设置中启用/禁用
- ✅ **日志级别调节** - 5级日志：off/error/warning/info/debug
- ✅ **快捷键录制模式** - 实验性功能，支持自定义快捷键录制

#### 优化的设置项
- 🔧 双击 Cmd 阈值可调节（从 SettingsManager 读取，不再硬编码）
- 🔧 缓存时长可调节（1-72小时）
- 🔧 最大缓存应用数可调节（10-100个）
- 🔧 所有设置实时保存到 UserDefaults 并生效

**相关提交**:
- `44b8e9f` - 完成设置功能完善与日志系统 🎉

---

### 2. UI 美化与优化

#### 设置面板优化
- 🎨 左侧菜单垂直外边距增加（上下各+6px）
- 🎨 右侧内容区域底部外边距统一调整为 32px
- 🎨 所有6个设置面板布局一致
- 🎨 侧边栏整行可点击（不仅限于图标和文字）

**相关提交**:
- `abfeff0` - 设置面板布局优化 ✨

#### 全局映射面板优化
- 🎨 添加按钮样式统一（28px 高度，白色/灰色背景）
- 🎨 添加/编辑映射弹窗宽度优化（450px → 300px）
- 🎨 弹窗高度改为自适应
- 🎨 输入框高度统一 28px
- 🎨 快捷键显示使用 KeyBadge 风格（深色背景 + 白色文字）
- 🎨 清空所有按钮优化（红色半透明背景 + 红色边框）
- ✨ 添加快捷键录制功能按钮
- ✨ 录制状态视觉反馈（录制时输入框变灰，按钮变红）

**相关提交**:
- `abbf190` - 全局映射面板UI优化 ✨
- `1bfe5ed` - 添加/编辑映射弹窗优化（第二轮） ✨

#### 菜单栏优化
- 🎨 菜单栏"显示快捷键面板"显示动态快捷键（⌘⌘）
- 🎨 快捷键根据设置自动更新（双击Cmd/Option/Control）
- 🎨 添加自定义通知 `.triggerKeyChanged` 避免无限循环
- 🐛 修复无限循环导致创建 100+ 个菜单栏窗口的严重 bug

**相关提交**:
- `96801b8` - UI美化与菜单栏优化 ✨

#### 快捷键面板优化
- 🎨 统一所有按钮高度为 28px，垂直内边距 2px
- 🎨 按钮背景色：浅色模式白色，深色模式灰色
- 🎨 扩展按钮点击区域到整个按钮范围
- ✨ 失去焦点自动关闭（点击面板外部自动关闭）
- ✨ 失去焦点时自动清理资源（ESC监听器、定时器）

**相关提交**:
- `ddeae3d` - 快捷键面板失去焦点自动关闭 ✨

#### 应用图标优化
- 🎨 App Logo 更新为 1024x1024 PDF 矢量格式
- 🎨 启用 `preserves-vector-representation` 保持矢量特性
- 🎨 清理旧的 PNG 图标文件
- 🎨 所有显示 App Icon 的地方自动使用新 logo

**相关提交**:
- `17f6811` - App Logo 更新为 PDF 矢量格式 ✨

---

### 3. 统计分析优化

#### 动画效果
- ✨ 统计分析窗口添加数字滚动动画效果
- ✨ 进度条和柱状图添加生长动画效果
- ✨ 所有动画组件支持数据切换时自动重新播放

#### 数据同步修复
- 🎨 时间周期文案优化："本周"改为"过去7天"，"本月"改为"过去30天"
- 📊 统计数据来源统一：概览和趋势图都从 `usage_records` 表查询
- 🐛 修复快速切换标签时动画状态不同步问题
- 🐛 修复概览与趋势图数据相差 1 的问题

#### 技术改进
- 🔧 所有动画组件采用统一的状态缓存模式（`pendingValue` 模式）
- 🔧 趋势图查询改为实时数据查询，避免聚合表延迟
- 🔧 动画触发采用 `isAnimating` 先重置再触发的方式

**相关提交**:
- `bba8a9e` - 优化统计分析面板功能
- `34ba9c2` - 统计分析动画优化与数据同步修复 🎨

---

### 4. Bug 修复

#### 使用统计追踪功能修复
- 🐛 修复 `SettingsManager` 中 6 个 Bool 属性读取错误
- 🐛 `UserDefaults.bool(forKey:)` 在键不存在时返回 `false` 而非默认值
- ✅ 改用 `defaults.object(forKey:) as? Bool ?? defaultValue` 模式
- ✅ 修复 `enableUsageTracking` 默认值不生效的问题

**相关提交**:
- `768c30d` - 修复使用统计追踪功能 Bug 🐛
- `546d6f0` - 更新修复使用统计追踪 Bug 的文档 📝

#### 数据库统计查询修复
- 🐛 修复 `loadDatabaseInfo()` 中查询结果类型转换错误
- 🐛 SQLite `COUNT(*)` 返回 `Int64`，不能直接转换为 `Int`
- ✅ 改用 `as? Int64` 后转换为 `Int(count)`
- 📊 优化统计显示："快捷键数"改为"已用快捷键"

**相关提交**:
- `1dfab81` - 修复数据库统计查询类型转换错误 🐛
- `6c16a46` - 优化数据库统计显示 ✨
- `e41e328` - 更新数据库统计修复相关文档 📝

#### 长驻应用列表优化
- 🎯 只显示有快捷键的应用（`shortcutCount > 0`）
- 🎯 添加系统核心进程黑名单（40+ 个系统组件）
- 🎯 排除 Helper/Plugin/Renderer 等辅助进程
- 🎯 第三方应用优先排序

**相关提交**:
- `abbf190` - 全局映射面板UI优化 ✨

#### 快捷键重复问题修复
- 🐛 修复快捷键提取时的重复问题
- ✅ 实现完整去重机制

**相关提交**:
- `0cb7f58` - 修复快捷键重复问题 - 完整去重机制

---

### 5. 新增工具类

#### Logger 日志系统
- 📝 五级日志控制（off=0, error=1, warning=2, info=3, debug=4）
- 📝 格式化输出：时间戳 + 级别 + Emoji + 消息
- 📝 Debug 级别包含文件名和行号
- 📝 从 SettingsManager 动态读取日志级别

**新增文件**: `Keymap/Utilities/Logger.swift`

#### KeyRecorder 快捷键录制器
- ⌨️ 使用 `NSEvent.addLocalMonitorForEvents` 监听按键
- ⌨️ 自动过滤单独修饰键
- ⌨️ 支持特殊键（F1-F20、方向键、Space 等）
- ⌨️ 录制完成后自动停止并回调

**新增文件**: `Keymap/Core/Recording/KeyRecorder.swift`

---

## 🔧 技术改进

### 架构优化
- 🏗️ 双击检测器完全重构（`DoubleCmdDetector.swift`）
  - 新增 `ModifierKey` 枚举（command/option/control）
  - 从设置读取 `triggerKey`
  - 动态切换监听的修饰键
  - 使用 Logger 替代 print 输出

### 代码质量
- 🔧 所有 print 语句替换为 Logger
- 🔧 模块化设计，各功能独立可测试
- 🔧 使用 Combine 框架实现设置双向绑定
- 🔧 Timer 实现面板自动关闭
- 🔧 NSEvent 本地监听实现按键录制

---

## 📁 修改文件列表

### 核心文件
1. `Keymap/Data/SettingsManager.swift` - 新增 5 个配置项和相关逻辑
2. `Keymap/Core/Monitoring/DoubleCmdDetector.swift` - 完全重构
3. `Keymap/Core/Monitoring/GlobalEventMonitor.swift` - 新增功能开关检查
4. `Keymap/Core/ShortcutExtraction/ShortcutCache.swift` - 从设置读取配置
5. `Keymap/Core/Monitoring/GlobalShortcutDatabase.swift` - 智能过滤系统进程

### UI 文件
6. `Keymap/UI/Views/Settings/SettingsWindow.swift` - 实现所有设置功能
7. `Keymap/UI/Views/ShortcutPanel/ShortcutPanelWindow.swift` - 自动关闭Timer
8. `Keymap/UI/Views/ShortcutPanel/ShortcutPanelView.swift` - 按钮美化
9. `Keymap/UI/Views/Statistics/StatisticsWindow.swift` - 动画和数据同步

### 数据层
10. `Keymap/Data/Repositories/UsageRepository.swift` - 实时数据查询

### 工具类
11. `Keymap/Utilities/Logger.swift` - 新增
12. `Keymap/Core/Recording/KeyRecorder.swift` - 新增

### 配置文件
13. `project.yml` - 版本升级到 1.1.0
14. `CHANGELOG.md` - 新增
15. `Keymap/Resources/Assets.xcassets/` - App Logo 更新

---

## 📊 统计数据

- **提交数量**: 17 个
- **修改文件**: 15 个（新增 3 个）
- **代码行数**: +1074 / -974
- **开发时间**: 2025-12-20 至 2025-12-25（6天）
- **主要贡献者**: David Lan

---

## 🎯 功能分布

| 类别 | 占比 | 说明 |
|------|------|------|
| 设置系统完善 | 40% | 7个新设置项 + 日志系统 + 录制器 |
| UI 美化优化 | 30% | 设置面板、映射面板、菜单栏、图标 |
| Bug 修复 | 15% | 统计追踪、数据库查询、重复问题 |
| 统计分析优化 | 15% | 动画效果、数据同步 |

---

## 🚀 升级指南

### 从 v1.0.0 升级

1. **自动升级**（推荐）
   ```bash
   # 拉取最新代码
   git pull origin main

   # 重新生成项目
   xcodegen generate

   # 编译运行
   xcodebuild -project Keymap.xcodeproj -scheme Keymap build
   ```

2. **手动升级**
   - 下载 v1.1.0 版本
   - 删除旧版本应用
   - 安装新版本
   - 重新授予辅助功能权限

### 配置迁移

所有设置自动迁移，无需手动配置。首次启动时：
- 日志级别默认为 `warning`
- 触发快捷键默认为"双击Cmd"
- 面板自动关闭默认禁用（0秒）
- 其他设置保持 v1.0.0 的默认值

---

## ⚠️ 已知问题

无重大已知问题。

---

## 🔮 下一步计划

v1.2.0 可能包含：
- 🌐 多语言支持（英文、中文）
- 🔍 高级搜索功能
- 📱 iCloud 同步支持
- 🎨 自定义主题支持

---

## 🙏 致谢

感谢所有测试和反馈的用户！

---

**完整更新日志**: [CHANGELOG.md](../../CHANGELOG.md)
**GitHub Release**: https://github.com/imdlan/Keymap/releases/tag/v1.1.0
