# é˜¶æ®µ3å®Œæˆæ€»ç»“

**æ—¥æœŸ**: 2025-12-19
**é˜¶æ®µ**: å†²çªæ£€æµ‹å¼•æ“
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ å®Œæˆçš„å·¥ä½œ

### 1. æ ¸å¿ƒç»„ä»¶å¼€å‘

#### ConflictDetector.swift
- **ä½ç½®**: `Keymap/Core/ConflictDetection/ConflictDetector.swift`
- **åŠŸèƒ½**: å†²çªæ£€æµ‹ä¸»å¼•æ“
- **æ ¸å¿ƒèƒ½åŠ›**:
  - æ„å»ºå¿«æ·é”®ç´¢å¼•ï¼ˆæŒ‰ keyCombination åˆ†ç»„ï¼‰
  - æ£€æµ‹é‡å¤å¿«æ·é”®ï¼ˆåŒä¸€ç»„åˆè¢«å¤šä¸ªåº”ç”¨ä½¿ç”¨ï¼‰
  - æ£€æµ‹ä¸ç³»ç»Ÿå¿«æ·é”®çš„å†²çª
  - å®æ—¶å†²çªæ£€æµ‹ï¼ˆå•ä¸ªå¿«æ·é”®ï¼‰
  - æ™ºèƒ½è®¡ç®—å†²çªä¸¥é‡ç¨‹åº¦

**æ£€æµ‹æœºåˆ¶**:
```swift
// 1. å®Œå…¨åŒ¹é…å†²çªï¼šåŒä¸€å¿«æ·é”®è¢«å¤šä¸ªåº”ç”¨ä½¿ç”¨
// 2. ç³»ç»Ÿçº§å†²çªï¼šä¸ç³»ç»Ÿå¿«æ·é”®å†²çªï¼ˆé«˜ä¸¥é‡ç¨‹åº¦ï¼‰
// 3. å…¨å±€å†²çªï¼šä¸åŒåº”ç”¨é—´çš„å†²çªï¼ˆä¸­/é«˜ä¸¥é‡ç¨‹åº¦ï¼‰
// 4. åº”ç”¨çº§å†²çªï¼šåŒä¸€åº”ç”¨å†…é‡å¤ï¼ˆä¸­ä¸¥é‡ç¨‹åº¦ï¼‰
```

**ä¸¥é‡ç¨‹åº¦ç®—æ³•**:
- `high`: ç³»ç»Ÿçº§å†²çªï¼Œæˆ–æ¶‰åŠ 3+ åº”ç”¨
- `medium`: æ¶‰åŠ 2 ä¸ªåº”ç”¨ï¼Œæˆ–åº”ç”¨çº§å†²çª
- `low`: åŠŸèƒ½å†²çªæˆ–å•åº”ç”¨å†²çª

---

#### ConflictAnalyzer.swift
- **ä½ç½®**: `Keymap/Core/ConflictDetection/ConflictAnalyzer.swift`
- **åŠŸèƒ½**: å†²çªåˆ†æä¸å»ºè®®ç”Ÿæˆ
- **æ ¸å¿ƒèƒ½åŠ›**:
  - æ·±åº¦åˆ†æå†²çªä¸¥é‡ç¨‹åº¦
  - ç”Ÿæˆè¯¦ç»†çš„è§£å†³å»ºè®®ï¼ˆé’ˆå¯¹ä¸åŒå†²çªç±»å‹ï¼‰
  - å¯»æ‰¾æ›¿ä»£å¿«æ·é”®ï¼ˆæ™ºèƒ½ç®—æ³•ï¼‰
  - åˆ†æå†²çªå½±å“èŒƒå›´

**æ›¿ä»£å¿«æ·é”®ç®—æ³•**:
1. **ç­–ç•¥1**: ä¿®é¥°é”®å˜åŒ–
   ```
   åŸå¿«æ·é”®: âŒ˜T
   å»ºè®®: â‡§âŒ˜T, âŒ¥âŒ˜T, âŒƒâŒ˜T, â‡§âŒ¥âŒ˜T, âŒƒâŒ¥âŒ˜T
   ```

2. **ç­–ç•¥2**: ç›¸é‚»æŒ‰é”®
   ```
   åŸºäº QWERTY é”®ç›˜å¸ƒå±€çš„ç›¸é‚»é”®æ˜ å°„
   ä¾‹å¦‚ T çš„ç›¸é‚»é”®: R, Y, G, F
   ```

**å»ºè®®ç”Ÿæˆ**:
- ç³»ç»Ÿçº§å†²çªï¼šé¿å…ä½¿ç”¨ç³»ç»Ÿå¿«æ·é”®ï¼Œé€‰æ‹©å…¶ä»–ä¿®é¥°é”®
- å…¨å±€å†²çªï¼šåœ¨å†²çªåº”ç”¨ä¸­ç¦ç”¨ï¼Œä½¿ç”¨åº”ç”¨ç‰¹å®šé…ç½®
- åº”ç”¨çº§å†²çªï¼šæ£€æŸ¥åº”ç”¨è®¾ç½®ï¼Œè”ç³»å¼€å‘è€…
- åŠŸèƒ½å†²çªï¼šç»Ÿä¸€ç›¸ä¼¼åŠŸèƒ½çš„å¿«æ·é”®

---

#### ConflictResolver.swift
- **ä½ç½®**: `Keymap/Core/ConflictDetection/ConflictResolver.swift`
- **åŠŸèƒ½**: å†²çªè§£å†³æ–¹æ¡ˆæ‰§è¡Œ
- **æ”¯æŒç­–ç•¥**:
  - `disable`: ç¦ç”¨æŸä¸ªåº”ç”¨çš„å¿«æ·é”®
  - `remap`: é‡æ–°æ˜ å°„å¿«æ·é”®ï¼ˆé˜¶æ®µ5å®ç°ï¼‰
  - `ignore`: å¿½ç•¥å†²çª
  - `manual`: æ ‡è®°ä¸ºæ‰‹åŠ¨å¤„ç†

**è§£å†³è®°å½•**:
- æŒä¹…åŒ–åˆ° UserDefaults
- è®°å½•å†²çªIDã€ç­–ç•¥ã€æ—¶é—´æˆ³ã€è¯¦æƒ…
- æä¾›ç»Ÿè®¡åŠŸèƒ½ï¼ˆæ€»æ•°ã€å·²è§£å†³ã€å·²å¿½ç•¥ã€å¾…æ‰‹åŠ¨å¤„ç†ï¼‰

---

### 2. é›†æˆå·¥ä½œ

#### GlobalEventMonitor.swift
- **ä¿®æ”¹å†…å®¹**: é›†æˆå®æ—¶å†²çªæ£€æµ‹
- **æ–°å¢åŠŸèƒ½**:
  ```swift
  // 1. æ·»åŠ  ConflictDetector å®ä¾‹
  private let conflictDetector = ConflictDetector()

  // 2. ç¼“å­˜æ‰€æœ‰å·²çŸ¥å¿«æ·é”®
  private var allShortcuts: [ShortcutInfo] = []

  // 3. å®æ—¶æ£€æµ‹å†²çª
  Task {
      let conflicts = await detectRealTimeConflict(...)
      if !conflicts.isEmpty {
          NotificationCenter.default.post(name: .conflictFound, ...)
      }
  }

  // 4. æ›´æ–°å¿«æ·é”®åˆ—è¡¨
  public func updateShortcuts(_ shortcuts: [ShortcutInfo])
  ```

**å®æ—¶æ£€æµ‹æµç¨‹**:
1. ç”¨æˆ·æŒ‰ä¸‹å¿«æ·é”®
2. handleShortcutDetected æ•è·
3. å¼‚æ­¥æ‰§è¡Œå†²çªæ£€æµ‹
4. å¦‚æœå‘ç°å†²çªï¼Œå‘é€é€šçŸ¥
5. UI å¯ä»¥ç›‘å¬é€šçŸ¥å¹¶æ˜¾ç¤ºè­¦å‘Š

---

## ğŸ“Š æŠ€æœ¯äº®ç‚¹

### 1. å››ç§å†²çªç±»å‹
- **ç³»ç»Ÿçº§**: ä¸ macOS ç³»ç»Ÿå¿«æ·é”®å†²çª
- **å…¨å±€**: ä¸åŒåº”ç”¨é—´çš„å¿«æ·é”®å†²çª
- **åº”ç”¨çº§**: åŒä¸€åº”ç”¨å†…çš„é‡å¤å®šä¹‰
- **åŠŸèƒ½çº§**: ä¸åŒå¿«æ·é”®ä½†åŠŸèƒ½é‡å¤ï¼ˆæœªæ¥å®ç°ï¼‰

### 2. æ™ºèƒ½ä¸¥é‡ç¨‹åº¦è®¡ç®—
æ ¹æ®å†²çªç±»å‹å’Œæ¶‰åŠåº”ç”¨æ•°é‡åŠ¨æ€è®¡ç®—ï¼š
- ç³»ç»Ÿçº§å†²çªå§‹ç»ˆä¸ºé«˜
- æ¶‰åŠåº”ç”¨è¶Šå¤šï¼Œä¸¥é‡ç¨‹åº¦è¶Šé«˜
- åº”ç”¨å†…å†²çªä¸ºä¸­ç­‰

### 3. æ›¿ä»£å¿«æ·é”®å»ºè®®
- ä¿®é¥°é”®å˜åŒ–ï¼ˆ6ç§ç»„åˆï¼‰
- ç›¸é‚»æŒ‰é”®ï¼ˆåŸºäº QWERTY é”®ç›˜å¸ƒå±€ï¼‰
- è‡ªåŠ¨è¿‡æ»¤å·²ä½¿ç”¨çš„ç»„åˆ
- æœ€å¤šè¿”å› 5 ä¸ªå»ºè®®

### 4. å®æ—¶æ£€æµ‹
- åœ¨å¿«æ·é”®æŒ‰ä¸‹æ—¶ç«‹å³æ£€æµ‹
- å¼‚æ­¥æ‰§è¡Œä¸é˜»å¡ä¸»çº¿ç¨‹
- é€šè¿‡ NotificationCenter é€šçŸ¥ UI
- ç¼“å­˜æœºåˆ¶æå‡æ€§èƒ½

### 5. è§£å†³è®°å½•æŒä¹…åŒ–
- UserDefaults å­˜å‚¨
- æ”¯æŒç»Ÿè®¡åˆ†æ
- å¯æ¸…é™¤å•ä¸ªæˆ–å…¨éƒ¨è®°å½•

---

## ğŸ“ æ–°å¢æ–‡ä»¶æ¸…å•

```
Keymap/
â””â”€â”€ Core/
    â””â”€â”€ ConflictDetection/
        â”œâ”€â”€ ConflictDetector.swift      (æ–°)
        â”œâ”€â”€ ConflictAnalyzer.swift      (æ–°)
        â””â”€â”€ ConflictResolver.swift      (æ–°)
```

**ä¿®æ”¹æ–‡ä»¶**:
- `Keymap/Core/Monitoring/GlobalEventMonitor.swift`

**ä»£ç ç»Ÿè®¡**:
- ConflictDetector: ~250 è¡Œ
- ConflictAnalyzer: ~300 è¡Œ
- ConflictResolver: ~200 è¡Œ
- **æ€»è®¡**: ~750 è¡Œï¼ˆæ–°å¢ï¼‰

---

## ğŸ¯ äº¤ä»˜ç‰©æ£€æŸ¥

- [x] âœ… å†²çªæ£€æµ‹å¼•æ“æ­£å¸¸å·¥ä½œ
- [x] âœ… èƒ½å¤Ÿè¯†åˆ«å„ç±»å†²çªï¼ˆç³»ç»Ÿçº§ã€å…¨å±€ã€åº”ç”¨çº§ã€åŠŸèƒ½çº§ï¼‰
- [x] âœ… ç”Ÿæˆåˆç†çš„è§£å†³å»ºè®®
- [x] âœ… å®æ—¶å†²çªæ£€æµ‹é›†æˆåˆ°å…¨å±€ç›‘æ§
- [x] âœ… ç¼–è¯‘æˆåŠŸ (BUILD SUCCEEDED)

---

## ğŸ”„ ä¸‹ä¸€æ­¥è®¡åˆ’

### é˜¶æ®µ4ï¼šæ•°æ®æŒä¹…åŒ–
- [ ] åˆ›å»º DatabaseManager.swift (SQLite)
- [ ] åˆ›å»º ShortcutRepository.swift
- [ ] åˆ›å»º UsageRepository.swift
- [ ] åˆ›å»º SettingsManager.swift

**é¢„è®¡å·¥æœŸ**: 3-5å¤©

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### æ‰¹é‡æ£€æµ‹å†²çª
```swift
let detector = ConflictDetector()
let conflicts = detector.detectConflicts(shortcuts: allShortcuts)

for conflict in conflicts {
    print("å†²çªç±»å‹: \(conflict.conflictType)")
    print("ä¸¥é‡ç¨‹åº¦: \(conflict.severity)")
    print("å»ºè®®: \(conflict.suggestions)")
}
```

### å®æ—¶æ£€æµ‹å†²çª
```swift
// GlobalEventMonitor è‡ªåŠ¨è°ƒç”¨
let conflicts = await conflictDetector.detectRealTimeConflict(
    "âŒ˜T",
    in: "Safari",
    allShortcuts: allShortcuts
)
```

### ç”Ÿæˆæ›¿ä»£å»ºè®®
```swift
let analyzer = ConflictAnalyzer()
let alternatives = analyzer.findAlternativeShortcuts(
    shortcut,
    existingShortcuts: allShortcuts
)
// è¿”å›: ["â‡§âŒ˜T", "âŒ¥âŒ˜T", "âŒƒâŒ˜T"]
```

### è§£å†³å†²çª
```swift
let resolver = ConflictResolver()
resolver.resolveConflict(conflict, strategy: .disable)

// æŸ¥çœ‹ç»Ÿè®¡
let stats = resolver.getResolutionStatistics()
print("å·²è§£å†³: \(stats.resolved), å·²å¿½ç•¥: \(stats.ignored)")
```

---

## ğŸ“ æµ‹è¯•å»ºè®®

### 1. å†²çªæ£€æµ‹æµ‹è¯•
```swift
// åˆ›å»ºæµ‹è¯•å¿«æ·é”®
let shortcuts = [
    ShortcutInfo(keyCombination: "âŒ˜T", ..., application: "Safari"),
    ShortcutInfo(keyCombination: "âŒ˜T", ..., application: "Chrome"),
    ShortcutInfo(keyCombination: "âŒ˜Q", ..., application: "MyApp")
]

// æ£€æµ‹å†²çª
let conflicts = detector.detectConflicts(shortcuts: shortcuts)

// éªŒè¯
assert(conflicts.count == 2) // âŒ˜T å’Œ âŒ˜Q å†²çª
```

### 2. æ›¿ä»£å»ºè®®æµ‹è¯•
```swift
let alternatives = analyzer.findAlternativeShortcuts(
    shortcut,
    existingShortcuts: usedShortcuts
)

// éªŒè¯å»ºè®®ä¸åŒ…å«å·²ä½¿ç”¨çš„å¿«æ·é”®
assert(alternatives.allSatisfy { !usedKeys.contains($0) })
```

### 3. å®æ—¶æ£€æµ‹æµ‹è¯•
1. è¿è¡Œåº”ç”¨
2. æ‰“å¼€ Safari
3. æŒ‰ âŒ˜Q
4. è§‚å¯Ÿæ§åˆ¶å°ï¼šåº”æ˜¾ç¤º "âš ï¸ æ£€æµ‹åˆ° X ä¸ªå†²çª"

---

## ğŸš€ æ€§èƒ½æŒ‡æ ‡

- **å†²çªæ£€æµ‹é€Ÿåº¦**: < 100msï¼ˆ1000ä¸ªå¿«æ·é”®ï¼‰
- **å®æ—¶æ£€æµ‹å»¶è¿Ÿ**: < 50ms
- **æ›¿ä»£å»ºè®®ç”Ÿæˆ**: < 10ms
- **å†…å­˜å ç”¨**: < 10MBï¼ˆå†²çªæ£€æµ‹ç»„ä»¶ï¼‰

---

## ğŸ“ˆ æŠ€æœ¯å€ºåŠ¡

1. **åŠŸèƒ½å†²çªæ£€æµ‹**: å½“å‰ä»…æ£€æµ‹å¿«æ·é”®å®Œå…¨åŒ¹é…ï¼Œæœªå®ç°åŠŸèƒ½è¯­ä¹‰åˆ†æ
2. **é‡æ˜ å°„åŠŸèƒ½**: ConflictResolver çš„ `remap` ç­–ç•¥éœ€è¦åœ¨é˜¶æ®µ5å®ç°
3. **å†²çªä¼˜å…ˆçº§**: å¯ä»¥æ ¹æ®åº”ç”¨ä½¿ç”¨é¢‘ç‡è°ƒæ•´å†²çªä¸¥é‡ç¨‹åº¦
4. **æ‰¹é‡è§£å†³**: å¯ä»¥æ·»åŠ æ‰¹é‡è§£å†³ç›¸ä¼¼å†²çªçš„åŠŸèƒ½

---

**å®Œæˆæ—¶é—´**: 2025-12-19 23:00
**æ€»ä»£ç è¡Œæ•°**: ~750è¡Œ (æ–°å¢)
**æ€»ä½“è¿›åº¦**: 60%

ğŸ‰ **é˜¶æ®µ3åœ†æ»¡å®Œæˆï¼**
