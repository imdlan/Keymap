## 🤖 Assistant

# 快捷键冲突检测与管理系统 - 详细设计文档

## 1. 项目概述

### 1.1 项目目标
开发一个macOS平台的快捷键冲突检测与管理系统，提供实时冲突检测、可视化快捷键展示、临时修改功能以及详细的统计分析。

### 1.2 核心价值
- 无感知检测，零学习成本
- 可视化展示，直观解决冲突
- 智能统计分析，优化使用效率
- 临时修改支持，灵活适应需求

## 2. 功能架构

### 2.1 核心功能模块

#### 2.1.1 冲突检测模块
- **实时监控**：全局快捷键监听
- **冲突识别**：自动检测快捷键冲突
- **冲突分类**：系统级、应用级、用户级冲突
- **冲突建议**：提供解决方案建议

#### 2.1.2 可视化界面模块
- **快捷键面板**：双击cmd触发半透明窗口
- **快捷键展示**：分类显示当前应用所有快捷键
- **冲突标注**：高亮显示冲突快捷键
- **临时修改**：支持快捷键临时重映射

#### 2.1.3 统计分析模块
- **使用统计**：记录快捷键使用频率
- **效率分析**：计算快捷键使用效率
- **习惯分析**：分析用户使用习惯
- **优化建议**：基于数据提供优化方案

### 2.2 技术架构

```
┌─────────────────────────────────────────────┐
│              用户界面层                      │
│  ┌─────────────┬─────────────┬─────────────┐ │
│  │  菜单栏图标 │   快捷键面板 │  统计分析界面 │ │
│  └─────────────┴─────────────┴─────────────┘ │
├─────────────────────────────────────────────┤
│              业务逻辑层                      │
│  ┌─────────────┬─────────────┬─────────────┐ │
│  │  冲突检测   │   界面控制   │  统计分析引擎 │ │
│  └─────────────┴─────────────┴─────────────┘ │
├─────────────────────────────────────────────┤
│              系统接口层                      │
│  ┌─────────────┬─────────────┬─────────────┐ │
│  │  事件监听   │   应用程序   │  数据存储   │ │
│  └─────────────┴─────────────┴─────────────┘ │
└─────────────────────────────────────────────┘
```

## 3. 详细功能设计

### 3.1 冲突检测功能

#### 3.1.1 检测机制
```swift
// 全局快捷键监听
class GlobalKeyMonitor {
    func setupGlobalMonitor() {
        // 监听所有键盘事件
        // 过滤非快捷键组合
        // 检测冲突情况
        // 触发冲突通知
    }
    
    func detectConflicts(shortcutKey: KeyCombination) -> [ConflictInfo] {
        // 查询系统注册的快捷键
        // 查询当前应用的快捷键
        // 比较检测结果
        // 返回冲突信息
    }
}
```

#### 3.1.2 冲突分类
- **系统级冲突**：与系统保留快捷键冲突
- **应用级冲突**：与应用内快捷键冲突
- **全局冲突**：与全局热键冲突
- **功能冲突**：功能重复但快捷键不同

### 3.2 快捷键面板设计

#### 3.2.1 触发机制
- 双击 Cmd 键（可配置）
- 支持自定义触发快捷键
- 智能识别当前应用上下文

#### 3.2.2 界面设计
```
┌─────────────────────────────────────────────┐
│  Safari 快捷键面板                    ✕   │
├─────────────────────────────────────────────┤
│  🔍 搜索快捷键...                          │
├─────────────────────────────────────────────┤
│  ⚠️  冲突快捷键 (3)                        │
│  ┌──────────────┬─────────────────────────┐│
│  │ ⌘+T         │ 新建标签              ││
│  │ ⌘+W         │ 关闭标签页            ││
│  │ ⌘+Q ⚠️      │ 退出 (冲突: 系统级)   ││
│  └──────────────┴─────────────────────────┘│
├─────────────────────────────────────────────┤
│  📝  常用快捷键 (12)                       │
│  ┌──────────────┬─────────────────────────┐│
│  │ ⌘+C         │ 复制                 ││
│  │ ⌘+V         │ 粘贴                 ││
│  │ ⌘+Z         │ 撤销                 ││
│  └──────────────┴─────────────────────────┘│
├─────────────────────────────────────────────┤
│  [🔧 临时修改]  [📊 统计]  [⚙️ 设置]       │
└─────────────────────────────────────────────┘
```

#### 3.2.3 临时修改功能
```swift
class ShortcutModifier {
    func enableTempModification(shortcut: String) {
        // 保存原始映射
        // 创建临时映射
        // 注册新的快捷键
        // 设置过期时间
    }
    
    func restoreOriginalMapping(shortcut: String) {
        // 移除临时映射
        // 恢复原始设置
        // 清理临时数据
    }
}
```

### 3.3 统计分析功能

#### 3.3.1 数据收集
```swift
class StatisticsCollector {
    func recordShortcutUsage(app: String, shortcut: String, timestamp: Date) {
        // 记录使用事件
        // 更新使用频率
        // 分析使用模式
    }
    
    func recordConflictResolution(conflictId: String, resolution: String) {
        // 记录冲突解决方式
        // 统计解决效果
        // 分析解决偏好
    }
}
```

#### 3.3.2 分析维度
- **使用频率分析**：统计各快捷键使用次数
- **冲突频率分析**：分析冲突发生模式
- **效率分析**：计算快捷键使用效率得分
- **习惯分析**：识别用户使用习惯和偏好
- **时间分析**：按时间段分析使用趋势

#### 3.3.3 统计界面设计
```
┌─────────────────────────────────────────────┐
│  快捷键统计分析                       🔧   │
├─────────────────────────────────────────────┤
│  📊 今日概览                               │
│  ┌─────────────┬─────────────┬─────────────┐│
│  │ 使用次数    │ 冲突次数    │ 效率得分    ││
│  │    156      │     3       │    85%      ││
│  │   ↑12%      │   ↓25%      │   ↑8%       ││
│  └─────────────┴─────────────┴─────────────┘│
├─────────────────────────────────────────────┤
│  🏆 最常用快捷键 (Top 10)                   │
│  ┌──────────────┬─────────────┬─────────────┐│
│  │ 快捷键       │ 应用        │ 使用次数    ││
│  │ ⌘+C         │ 全局        │    45       ││
│  │ ⌘+V         │ 全局        │    42       ││
│  │ ⌘+S         │ 多应用      │    28       ││
│  └──────────────┴─────────────┴─────────────┘│
├─────────────────────────────────────────────┤
│  ⚠️  高冲突快捷键                           │
│  ┌──────────────┬─────────────┬─────────────┐│
│  │ ⌘+Q         │ 系统级      │    8        ││
│  │ ⌘+Tab       │ 系统级      │    6        ││
│  │ F11         │ 系统级      │    5        ││
│  └──────────────┴─────────────┴─────────────┘│
├─────────────────────────────────────────────┤
│  💡 优化建议                               │
│  • 避免使用 ⌘+Q 作为应用快捷键             │
│  • 考虑为常用功能分配专用快捷键             │
│  • 减少鼠标操作，提高键盘使用率             │
├─────────────────────────────────────────────┤
│  [📈 详细报告]  [📥 导出数据]  [🔄 重置]    │
└─────────────────────────────────────────────┘
```

#### 3.3.4 分析算法
```swift
class EfficiencyAnalyzer {
    func calculateEfficiencyScore(usageData: [UsageRecord]) -> EfficiencyScore {
        let keyboardRatio = calculateKeyboardUsageRatio(usageData)
        let conflictPenalty = calculateConflictPenalty(usageData)
        let diversityBonus = calculateShortcutDiversity(usageData)
        
        return EfficiencyScore(
            overallScore: keyboardRatio * 100 - conflictPenalty + diversityBonus,
            keyboardRatio: keyboardRatio,
            conflictRate: conflictPenalty,
            diversityIndex: diversityBonus
        )
    }
    
    func generateOptimizationSuggestions(analysis: UsageAnalysis) -> [Suggestion] {
        var suggestions: [Suggestion] = []
        
        // 分析常用功能是否有快捷键
        // 分析冲突频率高的快捷键
        // 分析使用效率低的应用
        // 生成个性化建议
        
        return suggestions
    }
}
```

## 4. 数据模型设计

### 4.1 核心数据结构
```swift
struct ShortcutInfo {
    let id: String
    let keyCombination: String
    let description: String
    let application: String
    let category: ShortcutCategory
    let isCustom: Bool
    let conflicts: [ConflictInfo]
}

struct ConflictInfo {
    let shortcutId: String
    let conflictType: ConflictType
    let conflictingApp: String?
    let severity: ConflictSeverity
    let suggestions: [String]
}

struct UsageRecord {
    let shortcutId: String
    let application: String
    let timestamp: Date
    let context: UsageContext
}

struct StatisticsSummary {
    let totalUsage: Int
    let conflictCount: Int
    let efficiencyScore: Double
    let topShortcuts: [ShortcutUsage]
    let timeRange: DateInterval
}
```

### 4.2 数据存储策略
- **实时数据**：内存存储，应用重启时清空
- **统计数据**：SQLite存储，支持历史查询
- **配置数据**：UserDefaults存储，保存用户设置
- **临时数据**：临时文件存储，定期清理

## 5. 用户交互设计

### 5.1 主要用户流程

#### 5.1.1 日常使用流程
1. 用户正常使用计算机
2. 系统后台自动检测冲突
3. 发现冲突时显示轻量级通知
4. 用户双击Cmd查看详情
5. 在面板中进行临时修改
6. 系统记录使用数据

#### 5.1.2 统计查看流程
1. 用户点击菜单栏图标
2. 选择"统计分析"选项
3. 查看各类统计数据
4. 获取优化建议
5. 导出数据报告

### 5.2 交互设计原则
- **最小干扰**：不干扰正常工作流程
- **快速响应**：界面响应时间 < 200ms
- **清晰直观**：信息层次清晰，易于理解
- **可定制性**：支持个性化配置

## 6. 技术实现方案

### 6.1 开发技术栈
- **开发语言**：Swift
- **UI框架**：SwiftUI + AppKit
- **数据存储**：Core Data + SQLite
- **监控技术**：CGEvent + Accessibility
- **图表展示**：Charts 框架

### 6.2 关键技术实现

#### 6.2.1 全局快捷键监控
```swift
class GlobalMonitor {
    private var eventTap: CFMachPort?
    
    func setupMonitor() {
        let eventMask = (1 << CGEventType.keyDown.rawValue) |
                       (1 << CGEventType.flagsChanged.rawValue)
        
        guard let eventTap = CGEvent.tapCreate(
            tap: .cgAnnotatedSessionEventTap,
            place: .headInsertEventTap,
            options: .defaultTap,
            eventsOfInterest: CGEventMask(eventMask),
            callback: eventCallback,
            userInfo: nil
        ) else { return }
        
        self.eventTap = eventTap
        let runLoopSource = CFMachPortCreateRunLoopSource(kCFAllocatorDefault, eventTap, 0)
        CFRunLoopAddSource(CFRunLoopGetCurrent(), runLoopSource, .commonModes)
    }
    
    private let eventCallback: CGEventTapCallBack = { (proxy, type, event, userInfo) in
        // 处理键盘事件
        // 检测快捷键
        // 记录使用数据
        return Unmanaged.passUnretained(event).toOpaque()
    }
}
```

#### 6.2.2 应用快捷键获取
```swift
class AppShortcutExtractor {
    func extractShortcuts(for app: NSRunningApplication) -> [ShortcutInfo] {
        var shortcuts: [ShortcutInfo] = []
        
        // 1. 从应用菜单获取
        shortcuts.append(contentsOf: extractFromMenu(app))
        
        // 2. 从Info.plist获取
        shortcuts.append(contentsOf: extractFromInfoPlist(app))
        
        // 3. 从系统注册表获取
        shortcuts.append(contentsOf: extractFromSystemRegistration(app))
        
        return shortcuts
    }
    
    private func extractFromMenu(_ app: NSRunningApplication) -> [ShortcutInfo] {
        // 使用Accessibility API遍历应用菜单
        // 提取快捷键信息
        // 返回快捷键列表
    }
}
```

### 6.3 性能优化策略
- **惰性加载**：按需加载数据和界面
- **缓存机制**：缓存常用数据和计算结果
- **异步处理**：耗时操作异步执行
- **内存管理**：及时释放不需要的数据

## 7. 测试方案

### 7.1 单元测试
- 快捷键检测逻辑测试
- 统计分析算法测试
- 数据持久化测试
- 冲突解决逻辑测试

### 7.2 集成测试
- 系统集成测试
- 多应用场景测试
- 性能压力测试
- 兼容性测试

### 7.3 用户测试
- 可用性测试
- 性能体验测试
- 功能完整性测试
- 长期使用稳定性测试

## 8. 发布计划

### 8.1 开发里程碑
- **M1版本**（4周）：基础冲突检测功能
- **M2版本**（6周）：面板界面和临时修改
- **M3版本**（8周）：统计分析功能
- **正式版**（10周）：完整功能和优化

### 8.2 发布渠道
- Mac App Store
- GitHub Release
- 官方网站下载

## 9. 项目风险与应对

### 9.1 技术风险
- **系统权限**：需要辅助功能权限
- **兼容性**：不同macOS版本差异
- **性能影响**：监控可能影响系统性能

### 9.2 应对策略
- **权限提示**：清晰的权限申请引导
- **版本兼容**：支持多个系统版本
- **性能优化**：优化监控算法和资源使用

---

这份设计文档涵盖了快捷键冲突检测与管理的完整功能方案，包括冲突检测、可视化界面、临时修改和统计分析等核心功能，为项目开发提供了详细的指导。
